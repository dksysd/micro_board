services:
  # 개발환경용 데이터베이스들
  auth-db:
    image: postgres:14-alpine
    container_name: microboard-auth-db
    environment:
      POSTGRES_USER: authuser
      POSTGRES_PASSWORD: authpass
      POSTGRES_DB: authdb
    ports:
      - "5432:5432"
    volumes:
      - auth-db-data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - microboard-network

  post-db:
    image: postgres:14-alpine
    container_name: microboard-post-db
    environment:
      POSTGRES_USER: postuser
      POSTGRES_PASSWORD: postpass
      POSTGRES_DB: postdb
    ports:
      - "5433:5432"
    volumes:
      - post-db-data:/var/lib/postgresql/data
    networks:
      - microboard-network

  comment-db:
    image: postgres:14-alpine
    container_name: microboard-comment-db
    environment:
      POSTGRES_USER: commentuser
      POSTGRES_PASSWORD: commentpass
      POSTGRES_DB: commentdb
    ports:
      - "5434:5432"
    volumes:
      - comment-db-data:/var/lib/postgresql/data
    networks:
      - microboard-network

  # 백엔드 서비스들
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
      target: development
    container_name: microboard-auth-service
    environment:
      - DB_HOST=auth-db
      - DB_PORT=5432
      - DB_NAME=authdb
      - DB_USER=authuser
      - DB_PASSWORD=authpass
      - JWT_SECRET=dev-jwt-secret-key-change-in-production
      - NODE_ENV=development
      - PORT=3001
      - CORS_ORIGIN=http://localhost:3000
    ports:
      - "3001:3001"
    depends_on:
      - auth-db
    volumes:
      - ./auth-service:/app
      - /app/node_modules
    networks:
      - microboard-network

  post-service:
    build:
      context: ./post-service
      dockerfile: Dockerfile
      target: development
    container_name: microboard-post-service
    environment:
      - DB_HOST=post-db
      - DB_PORT=5432
      - DB_NAME=postdb
      - DB_USER=postuser
      - DB_PASSWORD=postpass
      - AUTH_SERVICE_URL=http://auth-service:3001
      - NODE_ENV=development
      - PORT=3002
      - CORS_ORIGIN=http://localhost:3000
    ports:
      - "3002:3002"
    depends_on:
      - post-db
      - auth-service
    volumes:
      - ./post-service:/app
      - /app/node_modules
    networks:
      - microboard-network

  comment-service:
    build:
      context: ./comment-service
      dockerfile: Dockerfile
      target: development
    container_name: microboard-comment-service
    environment:
      - DB_HOST=comment-db
      - DB_PORT=5432
      - DB_NAME=commentdb
      - DB_USER=commentuser
      - DB_PASSWORD=commentpass
      - AUTH_SERVICE_URL=http://auth-service:3001
      - POST_SERVICE_URL=http://post-service:3002
      - NODE_ENV=development
      - PORT=3003
      - CORS_ORIGIN=http://localhost:3000
    ports:
      - "3003:3003"
    depends_on:
      - comment-db
      - auth-service
      - post-service
    volumes:
      - ./comment-service:/app
      - /app/node_modules
    networks:
      - microboard-network

  # API Gateway (개발환경용)
  api-gateway:
    build: # Dockerfile을 사용하여 이미지를 빌드하도록 변경
      context: ./api-gateway # Dockerfile이 있는 디렉토리 경로
      dockerfile: Dockerfile # Dockerfile 이름 (기본값이므로 생략 가능)
    container_name: microboard-api-gateway
    ports:
      - "8080:80" # 호스트의 8080 포트를 컨테이너의 80 포트로 매핑
      # volumes: # Dockerfile에서 COPY 하므로, 개발 중 빠른 반영이 필요할 때만 주석 해제하여 사용
      # - ./api-gateway/nginx.conf:/etc/nginx/nginx.conf:ro
      # - ./api-gateway/snippets:/etc/nginx/snippets:ro # snippets 디렉토리 전체를 마운트
    depends_on:
      - auth-service
      - post-service
      - comment-service
    networks:
      - microboard-network
    restart: unless-stopped

  # 프론트엔드 (개발 서버)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: build
    container_name: microboard-frontend
    environment:
      - REACT_APP_API_URL=http://api-gateway:8080
      - CHOKIDAR_USEPOLLING=true
      - GENERATE_SOURCEMAP=false  # 빌드 속도 향상
      - DISABLE_ESLINT_PLUGIN=true  # ESLint 플러그인 비활성화 (선택사항)
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks:
      - microboard-network
    stdin_open: true
    tty: true
    command: npm start
    depends_on:
      - api-gateway  # API Gateway가 먼저 실행되도록

  # Redis (캐싱 및 세션 관리용 - 선택사항)
  redis:
    image: redis:7-alpine
    container_name: microboard-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - microboard-network
    command: redis-server --appendonly yes
    restart: unless-stopped

  # 개발용 도구들
  adminer:
    image: adminer
    container_name: microboard-adminer
    ports:
      - "8081:8080"
    networks:
      - microboard-network
    restart: unless-stopped

networks:
  microboard-network:
    driver: bridge

volumes:
  auth-db-data:
  post-db-data:
  comment-db-data:
  redis-data: